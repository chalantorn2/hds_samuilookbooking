// services/authService.js - Migrated to API Gateway
// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase calls ‡πÄ‡∏õ‡πá‡∏ô API Gateway calls
// ‡∏£‡∏±‡∏Å‡∏©‡∏≤ function signatures ‡πÅ‡∏•‡∏∞ return formats ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°

import { apiClient } from "../../services/apiClient";
// üîÑ MIGRATION PHASE: ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
// ‚úÖ ACTIVE: ‡πÉ‡∏ä‡πâ API Gateway ‡πÅ‡∏•‡πâ‡∏ß
// import { supabase } from "../../services/supabase"; // üîÑ Rollback: uncomment ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * @returns {Promise<{data: Array, error: Object}>} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
 */
export const fetchAllUsers = async () => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.get("/gateway.php", {
      action: "getUsers",
      search: "", // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      limit: 1000, // ‡πÄ‡∏û‡∏¥‡πà‡∏° limit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    });

    if (!response.success) {
      console.error("Error fetching users:", response.error);
      return { data: null, error: response.error };
    }

    // Sort by username ‡∏ï‡∏≤‡∏° logic ‡πÄ‡∏î‡∏¥‡∏°
    const sortedData = (response.data || []).sort((a, b) => {
      const usernameA = a.username || "";
      const usernameB = b.username || "";
      return usernameA.localeCompare(usernameB);
    });

    return { data: sortedData, error: null };
  } catch (error) {
    console.error("Error fetching users:", error);
    return { data: null, error: error.message };
  }
};

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
 * @param {Object} userData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @returns {Promise<{success: boolean, error: string}>} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 */
export const createUser = async (userData) => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.post("/gateway.php", {
      action: "createUser",
      data: {
        username: userData.username,
        password: userData.password, // API Gateway ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ plain text storage
        fullname: userData.fullname,
        email: userData.email,
        role: userData.role,
        active: userData.active,
      },
    });

    if (!response.success) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏à‡∏≤‡∏Å API Gateway
      if (response.error && response.error.includes("‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß")) {
        return {
          success: false,
          error: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
        };
      }
      return { success: false, error: response.error };
    }

    return { success: true };
  } catch (error) {
    console.error("Error creating user:", error);
    return { success: false, error: error.message };
  }
};

/**
 * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} userId ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {Object} userData ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
 * @returns {Promise<{success: boolean, error: string}>} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
 */
export const updateUser = async (userId, userData) => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.put("/gateway.php", {
      action: "updateUser",
      id: userId,
      data: {
        fullname: userData.fullname,
        email: userData.email,
        role: userData.role,
        active: userData.active,
      },
    });

    if (!response.success) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡∏à‡∏≤‡∏Å API Gateway
      if (response.error && response.error.includes("‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß")) {
        return { success: false, error: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß" };
      }
      return { success: false, error: response.error };
    }

    return { success: true };
  } catch (error) {
    console.error("Error updating user:", error);
    return { success: false, error: error.message };
  }
};

/**
 * ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} userId ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} newPassword ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
 * @returns {Promise<{success: boolean, error: string}>} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
 */
export const changePassword = async (userId, newPassword) => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.post("/gateway.php", {
      action: "changePassword",
      userId: userId,
      newPassword: newPassword,
    });

    if (!response.success) {
      return { success: false, error: response.error };
    }

    return { success: true };
  } catch (error) {
    console.error("Error changing password:", error);
    return { success: false, error: error.message };
  }
};

/**
 * ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {string} userId ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @param {boolean} hardDelete ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
 * @returns {Promise<{success: boolean, error: string}>} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏ö
 */
export const deleteUser = async (userId, hardDelete = false) => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.delete("/gateway.php", {
      action: "deleteUser",
      userId: userId,
      hardDelete: hardDelete,
    });

    if (!response.success) {
      return { success: false, error: response.error };
    }

    return { success: true };
  } catch (error) {
    console.error("Error deleting user:", error);
    return { success: false, error: error.message };
  }
};

/**
 * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° ID
 * @param {string} userId ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 * @returns {Promise<{data: Object, error: Object}>} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
 */
export const fetchUserById = async (userId) => {
  try {
    // üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏õ‡πá‡∏ô API Gateway
    const response = await apiClient.get("/gateway.php", {
      action: "getUserById",
      id: userId,
    });

    if (!response.success) {
      console.error("Error fetching user:", response.error);
      return { data: null, error: response.error };
    }

    return { data: response.data, error: null };
  } catch (error) {
    console.error("Error fetching user:", error);
    return { data: null, error: error.message };
  }
};
